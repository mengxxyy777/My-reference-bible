# AC自动机

​	自动机又叫确定有限状态自动机，是对信号序列进行判定的数学模型。常见的自动机有：前缀树、KMP自动机、回文自动机、AC自动机、后缀自动机。

​	经典的AC自动机就是前缀树加上fail指针。

​	fail指针含义：

​		1）AC自动机上的某个节点a，表示某个目标串的前缀串s的终止节点。

​		2）其他目标串的前缀串，要求和s的某个后缀串完全一样，并且要求长度最大，并且不能是s整体。

​	满足这两点的前缀串假设为t，那么节点a的fail指针就指向t的终止节点。

​	一旦匹配失败，就通过fail指针绕圈找到能继续的节点，然后继续匹配。

## AC自动机的功能

​	给出若干目标字符串，还有一篇文章，返回每个目标字符串在文章中出现了几次。

## AC自动机的经典过程

​	利用fail指针每次去加速匹配过程，收集词频时还需要fail指针一层一层标记，会出现fail指针绕圈的过程。

​	目标字符串先建立好前缀树，然后利用bfs计算fail指针：

​		根结点0的fail指针为0，根结点指向的第一层节点fail指针也为0；

​		当来到第二层及以后，看当前及父结点的路径上的字符，去父结点的fail指针指向的节点找，看看该节点是否有指向该字符的路径，如果有，则当前节点fail指针直接指向该节点；如果没有，那就去fail指针指向的节点的fail指针找，直到根结点0。这就是所谓的绕圈了，绕来绕去又回到头。

​	我们不妨回头看看fail指针有什么作用。来到某个节点时，对应着文章中找到了某段字符串，例如“abca”，可能在字典树中找到了abc，此时字典树如果再向下，例如是d，那么没有该路径，证明此时文章里走不出“abcd”这个目标串，这个时候我们要傻乎乎地再从“abca”的b开始重新匹配吗？这样恐怕很慢，这时能否想到KMPnext数组的优化策略？其实我们从“bca”这个前缀入手，看看是否有目标串与之匹配，如果有，相当于我们省去了“bca”三个位置的匹配过程，直接来到下一个位置开始匹配；如果没有对应匹配串，还可以来到“ca”这里，再看是否有前缀为“ca”的目标串，一直到单个字符都没有。

​	这个过程实际上就是：当匹配失败时，希望找到一个前缀串，它是当前已经配出来的字符串的后缀串，但是不是它本身，并且希望这个后缀串的长度尽可能的长，这样我们跳过无用的匹配位置就越多，从而达到优化匹配过程的目的。

## AC自动机优化

​	上面过程固然高效，但是fail指针在不断地追溯，不断地绕圈，这个过程耗时，我们就可以把fail指针优化一下，在建立这棵字典树时就可以优化。

​	来到一个位置，它不能去的所有位置都听从其父结点的fail指针，能去的位置便让该位置的fail指针与自己相同，相当在完善那棵表示字典树的数组。

​	这个过程由于bfs完成，所以，所有的fail指针的关系是逐层传递下去的，这样fail指针只需找一次就可以找到正确的去向，大大优化了时间效率。在比赛时也要实现这种AC自动机，不然时间可能不够的。

## code

## 练习题目及专属优化

​	根据fail指针反向建图，遍历图汇总词频得到答案：https://www.luogu.com.cn/problem/P5357

​	数位dp+AC自动机+在线查询预警：https://www.luogu.com.cn/problem/P3311